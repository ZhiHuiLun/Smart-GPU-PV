/********************************************************************************
* 文件名称：Utils.h
* 文件功能：提供通用的工具函数集合，包括字符串处理、编码转换、日志输出等
* 
* 类说明：
*    Utils是一个纯静态工具类，提供了项目中各个模块共用的基础功能函数。
*    主要包括字符串编码转换（UTF-8/UTF-16）、字符串处理（分割、修剪、查找）、
*    格式化输出、JSON解析、Windows UI辅助等功能。
* 
* 主要功能模块：
*    1. 字符串编码转换（UTF-8 <-> UTF-16）
*    2. 字符串处理（Split、Trim、Contains）
*    3. 格式化函数（FormatVRAMSize - 字节转GB/MB）
*    4. 简单JSON值提取（用于解析PowerShell输出）
*    5. Windows UI辅助（日志追加、消息框）
*    6. 字符编码修复（GBK转UTF-8）
* 
* 设计原则：
*    - 所有函数均为静态方法，无需实例化
*    - 注重易用性和可读性
*    - 提供基本错误处理
* 
* 依赖项：
*    - Windows API（字符串转换、UI操作）
*    - 标准C++库（string、vector、sstream）
* 
* 作者：Smart-GPU-PV Team
* 日期：2026-01-26
* 版本：v2.0
*********************************************************************************/

#pragma once
#include <string>
#include <vector>
#include <windows.h>

/********************************************************************************
* 类名称：工具函数类
* 类功能：提供字符串处理、编码转换、UI辅助等通用工具函数
*********************************************************************************/
class Utils {
public:
    //==============================================================================
    // 字符串编码转换
    //==============================================================================
    
    /********************************************************************************
    * 函数名称：窄字符串转宽字符串
    * 函数功能：将UTF-8编码的std::string转换为UTF-16编码的std::wstring
    * 函数参数：
    *    [IN]  const std::string& str：UTF-8编码的字符串
    * 返回类型：std::wstring
    *    转换后的UTF-16宽字符串
    * 调用示例：
    *    std::wstring wstr = Utils::StringToWString("Hello");
    *********************************************************************************/
    static std::wstring StringToWString(const std::string& str);
    
    /********************************************************************************
    * 函数名称：宽字符串转窄字符串
    * 函数功能：将UTF-16编码的std::wstring转换为UTF-8编码的std::string
    * 函数参数：
    *    [IN]  const std::wstring& wstr：UTF-16编码的宽字符串
    * 返回类型：std::string
    *    转换后的UTF-8字符串
    * 调用示例：
    *    std::string str = Utils::WStringToString(L"你好");
    *********************************************************************************/
    static std::string WStringToString(const std::wstring& wstr);
    
    //==============================================================================
    // 字符串处理
    //==============================================================================
    
    /********************************************************************************
    * 函数名称：字符串分割
    * 函数功能：根据指定分隔符将字符串分割为多个子字符串
    * 函数参数：
    *    [IN]  const std::string& str：待分割的字符串
    *    [IN]  char cDelimiter：分隔符字符
    * 返回类型：std::vector<std::string>
    *    分割后的子字符串数组
    * 调用示例：
    *    auto vecParts = Utils::Split("a,b,c", ',');
    *    // vecParts = {"a", "b", "c"}
    *********************************************************************************/
    static std::vector<std::string> Split(const std::string& str, char cDelimiter);
    
    /********************************************************************************
    * 函数名称：字符串修剪
    * 函数功能：移除字符串首尾的空白字符（空格、制表符、换行符）
    * 函数参数：
    *    [IN]  const std::string& str：待修剪的字符串
    * 返回类型：std::string
    *    修剪后的字符串
    * 调用示例：
    *    std::string strResult = Utils::Trim("  hello  ");
    *    // strResult = "hello"
    *********************************************************************************/
    static std::string Trim(const std::string& str);
    
    /********************************************************************************
    * 函数名称：字符串包含检查
    * 函数功能：检查字符串中是否包含指定子字符串
    * 函数参数：
    *    [IN]  const std::string& str：主字符串
    *    [IN]  const std::string& substr：要查找的子字符串
    * 返回类型：bool
    *    包含返回true，否则返回false
    * 调用示例：
    *    if (Utils::Contains(vmName, "Windows")) {
    *        // 虚拟机名称包含"Windows"
    *    }
    *********************************************************************************/
    static bool Contains(const std::string& str, const std::string& substr);
    
    //==============================================================================
    // 格式化函数
    //==============================================================================
    
    /********************************************************************************
    * 函数名称：格式化显存大小
    * 函数功能：将字节数转换为人类可读的GB或MB格式
    * 函数参数：
    *    [IN]  uint64_t ui64Bytes：字节数
    * 返回类型：std::string
    *    格式化后的字符串，如"4.00 GB"或"512.00 MB"
    * 调用示例：
    *    std::string strSize = Utils::FormatVRAMSize(4294967296);
    *    // strSize = "4.00 GB"
    *********************************************************************************/
    static std::string FormatVRAMSize(uint64_t ui64Bytes);
    
    //==============================================================================
    // JSON简单解析
    //==============================================================================
    
    /********************************************************************************
    * 函数名称：提取JSON值
    * 函数功能：从JSON字符串中提取指定键的值（简单解析，非完整JSON解析器）
    * 函数参数：
    *    [IN]  const std::string& strJson：JSON格式字符串
    *    [IN]  const std::string& strKey：要提取的键名
    * 返回类型：std::string
    *    提取到的值，若未找到则返回空字符串
    * 调用示例：
    *    std::string strName = Utils::ExtractJsonValue(json, "Name");
    * 注意事项：
    *    这是一个简化的JSON解析器，仅用于解析PowerShell ConvertTo-Json输出
    *    不支持嵌套对象和复杂JSON结构
    *********************************************************************************/
    static std::string ExtractJsonValue(const std::string& strJson, const std::string& strKey);
    
    //==============================================================================
    // Windows UI辅助
    //==============================================================================
    
    /********************************************************************************
    * 函数名称：追加日志到编辑框
    * 函数功能：向编辑框控件追加一行日志消息并自动滚动到底部
    * 函数参数：
    *    [IN]  HWND hEdit：编辑框控件句柄
    *    [IN]  const std::wstring& wstrMessage：要追加的消息
    * 返回类型：void
    * 调用示例：
    *    Utils::AppendLog(hLogEdit, L"正在启动虚拟机...");
    *********************************************************************************/
    static void AppendLog(HWND hEdit, const std::wstring& wstrMessage);
    
    /********************************************************************************
    * 函数名称：显示错误消息框
    * 函数功能：弹出错误样式的消息框
    * 函数参数：
    *    [IN]  HWND hWnd：父窗口句柄
    *    [IN]  const std::wstring& wstrMessage：错误消息内容
    * 返回类型：void
    * 调用示例：
    *    Utils::ShowError(hDlg, L"虚拟机启动失败！");
    *********************************************************************************/
    static void ShowError(HWND hWnd, const std::wstring& wstrMessage);
    
    /********************************************************************************
    * 函数名称：显示信息消息框
    * 函数功能：弹出信息样式的消息框
    * 函数参数：
    *    [IN]  HWND hWnd：父窗口句柄
    *    [IN]  const std::wstring& wstrMessage：信息消息内容
    * 返回类型：void
    * 调用示例：
    *    Utils::ShowInfo(hDlg, L"GPU-PV配置完成！");
    *********************************************************************************/
    static void ShowInfo(HWND hWnd, const std::wstring& wstrMessage);

    //==============================================================================
    // 字符编码修复
    //==============================================================================
    
    /********************************************************************************
    * 函数名称：修复乱码字符串
    * 函数功能：检测并修复GBK编码的字符串，转换为UTF-8
    * 函数参数：
    *    [IN]  const std::string& str：可能乱码的字符串
    * 返回类型：std::string
    *    修复后的UTF-8字符串
    * 调用示例：
    *    std::string strFixed = Utils::RepairString(output);
    * 注意事项：
    *    主要用于修复PowerShell输出的中文乱码问题（当控制台代码页为GBK时）
    *********************************************************************************/
    static std::string RepairString(const std::string& str);

private:
    /********************************************************************************
    * 函数名称：检查UTF-8有效性（内部辅助）
    * 函数功能：检查字符串是否为有效的UTF-8编码
    * 函数参数：
    *    [IN]  const std::string& str：待检查的字符串
    * 返回类型：bool
    *    有效返回true，否则返回false
    *********************************************************************************/
    static bool IsValidUTF8(const std::string& str);
    
    /********************************************************************************
    * 函数名称：GBK转UTF-8（内部辅助）
    * 函数功能：将GBK编码字符串转换为UTF-8编码
    * 函数参数：
    *    [IN]  const std::string& str：GBK编码字符串
    * 返回类型：std::string
    *    UTF-8编码字符串
    *********************************************************************************/
    static std::string ConvertGBKToUTF8(const std::string& str);
};
