/********************************************************************************
* 文件名称：VhdHelper.h
* 文件功能：提供VHD/VHDX虚拟磁盘操作的封装类
* 
* 类说明：
*    VhdHelper封装了Windows Virtual Disk API，提供VHD/VHDX文件的打开、
*    挂载、卸载等操作。主要用于挂载Hyper-V虚拟机的虚拟磁盘，以便复制
*    GPU驱动文件到虚拟机系统分区。
* 
* 主要功能：
*    1. VHD/VHDX文件打开和关闭（VhdHandle类，RAII管理）
*    2. 虚拟磁盘挂载和卸载
*    3. 自动识别系统分区驱动器号
*    4. 便捷的一键式挂载/卸载方法
* 
* 技术实现：
*    - 使用Virtual Disk API（virtdisk.lib）
*    - OpenVirtualDisk打开VHD/VHDX文件
*    - AttachVirtualDisk挂载虚拟磁盘
*    - DetachVirtualDisk卸载虚拟磁盘
*    - 通过查询卷信息识别系统分区
*    - RAII模式自动管理资源
* 
* 使用模式：
*    1. 创建VhdHandle对象
*    2. 调用Open()打开VHD文件
*    3. 调用Attach()挂载虚拟磁盘
*    4. 调用GetSystemDriveLetter()获取系统盘符
*    5. 进行文件操作
*    6. 对象析构时自动卸载和关闭
* 
* 依赖项：
*    - virtdisk.lib（Virtual Disk API库）
*    - Windows API（存储管理）
* 
* 使用注意：
*    - 需要管理员权限
*    - 挂载VHD前虚拟机必须处于关闭状态
*    - VhdHandle使用RAII模式，析构时自动清理资源
*    - 不支持并发操作同一VHD文件
* 
* 作者：Smart-GPU-PV Team
* 日期：2026-01-26
* 版本：v2.0
*********************************************************************************/

#pragma once
#include <windows.h>
#include <string>
#include <memory>

/********************************************************************************
* 类名称：VHD操作辅助类
* 类功能：封装VHD/VHDX文件的打开、挂载、卸载等操作
*********************************************************************************/
class VhdHelper {
public:
    //==============================================================================
    // 内嵌类：VHD句柄管理
    //==============================================================================
    
    /********************************************************************************
    * 类名称：VHD句柄（RAII管理）
    * 类功能：管理VHD/VHDX文件句柄，自动挂载和卸载虚拟磁盘
    * 
    * 使用说明：
    *    VhdHandle类采用RAII模式，构造时初始化句柄，析构时自动卸载虚拟磁盘
    *    并关闭句柄。确保资源正确释放，防止虚拟磁盘泄漏。
    * 
    * 调用示例：
    *    VhdHelper::VhdHandle objHandle;
    *    if (objHandle.Open(L"C:\\VM\\disk.vhdx", false)) {
    *        if (objHandle.Attach()) {
    *            std::wstring wstrDrive = objHandle.GetSystemDriveLetter();
    *            // 使用驱动器号进行文件操作
    *        }
    *    }  // 析构时自动卸载和关闭
    *********************************************************************************/
    class VhdHandle {
    public:
        /********************************************************************************
        * 函数名称：构造函数
        * 函数功能：初始化VHD句柄对象
        * 函数参数：
        *    无
        * 返回类型：无（构造函数）
        *********************************************************************************/
        VhdHandle();
        
        /********************************************************************************
        * 函数名称：析构函数
        * 函数功能：自动卸载虚拟磁盘并关闭句柄
        *********************************************************************************/
        ~VhdHandle();
        
        /********************************************************************************
        * 函数名称：打开VHD文件
        * 函数功能：打开指定的VHD或VHDX文件
        * 函数参数：
        *    [IN]  const std::wstring& wstrVhdPath：VHD/VHDX文件的完整路径
        *    [IN]  bool bReadOnly：是否以只读方式打开，默认为false（读写模式）
        * 返回类型：bool
        *    打开成功返回true，失败返回false
        * 调用示例：
        *    if (objHandle.Open(L"C:\\VMs\\Windows11.vhdx", false)) {
        *        // 文件打开成功
        *    }
        * 注意事项：
        *    - 文件必须存在且可访问
        *    - 虚拟机必须处于关闭状态
        *********************************************************************************/
        bool Open(const std::wstring& wstrVhdPath, bool bReadOnly = false);
        
        /********************************************************************************
        * 函数名称：挂载虚拟磁盘
        * 函数功能：将已打开的VHD/VHDX挂载到系统，使其可作为物理磁盘访问
        * 函数参数：
        *    无
        * 返回类型：bool
        *    挂载成功返回true，失败返回false
        * 调用示例：
        *    if (objHandle.Attach()) {
        *        // 虚拟磁盘已挂载
        *    }
        * 注意事项：
        *    - 必须先调用Open()成功打开文件
        *    - 需要管理员权限
        *********************************************************************************/
        bool Attach();
        
        /********************************************************************************
        * 函数名称：卸载虚拟磁盘
        * 函数功能：卸载已挂载的虚拟磁盘
        * 函数参数：
        *    无
        * 返回类型：bool
        *    卸载成功返回true，失败返回false
        * 调用示例：
        *    if (objHandle.Detach()) {
        *        // 虚拟磁盘已卸载
        *    }
        * 注意事项：
        *    - 卸载前应确保没有程序占用虚拟磁盘上的文件
        *    - 析构函数会自动调用Detach()
        *********************************************************************************/
        bool Detach();
        
        /********************************************************************************
        * 函数名称：获取系统分区驱动器号
        * 函数功能：识别并返回虚拟磁盘中系统分区的驱动器号
        * 函数参数：
        *    无
        * 返回类型：std::wstring
        *    驱动器号字符串（如"C:"），若未找到返回空字符串
        * 调用示例：
        *    std::wstring wstrDrive = objHandle.GetSystemDriveLetter();
        *    if (!wstrDrive.empty()) {
        *        std::wstring wstrDriverPath = wstrDrive + L"\\Windows\\System32\\drivers";
        *    }
        * 注意事项：
        *    - 必须先成功挂载虚拟磁盘
        *    - 通过查找Windows目录识别系统分区
        *********************************************************************************/
        std::wstring GetSystemDriveLetter();
        
        /********************************************************************************
        * 函数名称：检查句柄有效性
        * 函数功能：判断VHD句柄是否有效
        * 函数参数：
        *    无
        * 返回类型：bool
        *    句柄有效返回true，否则返回false
        *********************************************************************************/
        bool IsValid() const { return m_handle != INVALID_HANDLE_VALUE; }
        
        /********************************************************************************
        * 函数名称：获取原始句柄
        * 函数功能：返回底层的Windows句柄（供高级用户使用）
        * 函数参数：
        *    无
        * 返回类型：HANDLE
        *    VHD文件句柄
        *********************************************************************************/
        HANDLE GetHandle() const { return m_handle; }
        
    private:
        HANDLE m_handle;      // VHD文件句柄
        bool m_bAttached;     // 是否已挂载标志
        bool m_attached;      // 修正拼写错误（假设VhdHelper.cpp中使用的是m_attached）
        
        // 禁止拷贝构造和赋值（RAII对象不可复制）
        VhdHandle(const VhdHandle&) = delete;
        VhdHandle& operator=(const VhdHandle&) = delete;
    };
    
    //==============================================================================
    // 静态方法：便捷操作
    //==============================================================================
    
    /********************************************************************************
    * 函数名称：挂载VHD并获取系统驱动器号
    * 函数功能：一键式操作，打开并挂载VHD，返回系统分区驱动器号
    * 函数参数：
    *    [IN]  const std::wstring& wstrVhdPath：VHD/VHDX文件路径
    * 返回类型：std::wstring
    *    系统分区驱动器号（如"C:"），失败返回空字符串
    * 调用示例：
    *    std::wstring wstrDrive = VhdHelper::MountAndGetSystemDrive(L"C:\\VMs\\disk.vhdx");
    *    if (!wstrDrive.empty()) {
    *        // 复制文件到 wstrDrive + L"\\..."
    *        VhdHelper::Unmount(L"C:\\VMs\\disk.vhdx");
    *    }
    * 注意事项：
    *    - 使用完毕后必须调用Unmount()卸载
    *    - 建议使用VhdHandle类以确保自动清理
    *********************************************************************************/
    static std::wstring MountAndGetSystemDrive(const std::wstring& wstrVhdPath);
    
    /********************************************************************************
    * 函数名称：卸载VHD
    * 函数功能：卸载指定的VHD/VHDX文件
    * 函数参数：
    *    [IN]  const std::wstring& wstrVhdPath：VHD/VHDX文件路径
    * 返回类型：bool
    *    卸载成功返回true，失败返回false
    * 调用示例：
    *    if (VhdHelper::Unmount(L"C:\\VMs\\disk.vhdx")) {
    *        // 虚拟磁盘已卸载
    *    }
    * 注意事项：
    *    - 与MountAndGetSystemDrive()配对使用
    *    - 卸载前确保没有程序占用虚拟磁盘文件
    *********************************************************************************/
    static bool Unmount(const std::wstring& wstrVhdPath);
};
